---
name: stm32h7-driver-dev
description: 面向 STM32H7（HAL/CMSIS）驱动开发与维护的流程化技能。用于新增/修改外设驱动、排查驱动问题、梳理初始化与中断/DMA、以及对 board/driver 层进行代码评审时触发。
---

# Stm32h7 Driver Dev

## Overview

提供 STM32H7 外设驱动开发的标准流程与检查清单，覆盖需求拆解、时钟/引脚/中断/DMA 配置、HAL 封装、以及测试与回归要点。

## Workflow

按以下顺序执行；若已有信息不足，先收集再动代码。

### 1) 需求与边界
- 明确外设、通道、触发源、带宽/采样率、功耗与时序约束。
- 明确是否依赖 DMA、双缓冲、IRQ 优先级、RTOS 交互。
- 产出：接口清单（初始化/读写/回调/错误处理）。

### 2) 板级资源映射
- 确认时钟树、引脚复用、GPIO 电气属性、复位/使能脚。
- 对照 `project/usr/drivers/` 与 `project/usr/inc/` 的板级配置方式。
- 必要时补充 `*_desc.h` 的描述表或 `board.c` 配置项。

### 3) HAL/CMSIS 配置
- 按 HAL 标准流程配置 `MspInit`、时钟使能、GPIO、DMA、NVIC。
- 中断优先级遵循 FreeRTOS 规则（必要时检查 `FreeRTOSConfig.h`）。
- 外设初始化放在驱动层，避免应用层直接操作寄存器。

### 4) 驱动接口实现
- 对外提供最小稳定 API（init/open/start/stop/read/write/ioctl）。
- 尽量隔离 HAL 结构体与上层，必要时提供适配层。
- 错误码与超时策略一致化。

### 5) 中断/DMA 回调与线程安全
- 明确 ISR 与任务上下文的边界（只做轻量操作）。
- 需要同步时使用队列/信号量/事件组，避免在 ISR 里调用阻塞接口。
- 关键共享资源使用原子或临界区保护。

### 6) 测试与回归
- 提供最小可运行测试（初始化、收发/采样、异常路径）。
- 验证低功耗、复位后的恢复、异常输入下的稳定性。
- 记录测试条件与结果，便于复现。

## Review Checklist

- 时钟/引脚/中断是否匹配芯片手册与板卡硬件
- 中断优先级是否满足 FreeRTOS 限制
- DMA 缓冲区对齐/Cache 一致性是否处理（如 D-Cache）
- 错误路径是否可触发且可恢复
- HAL 句柄的生命周期与重入性是否明确

## References

- 将板级资源表、外设配置约定与常用测试流程放入 `references/`。
- 若需要自动化初始化或生成模板，可在 `scripts/` 增加脚本并在此处列出。
