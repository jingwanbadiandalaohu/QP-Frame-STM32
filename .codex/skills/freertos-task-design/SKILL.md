---
name: freertos-task-design
description: 面向基于 CMSIS-RTOS2 的任务划分与系统设计的流程化技能。用于新建任务、调整优先级/栈/调度策略、设计同步机制、排查任务死锁或实时性问题时触发；优先使用 CMSIS-RTOS 接口而非原生 FreeRTOS API。
---

# Freertos Task Design

## Overview

提供基于 CMSIS-RTOS2 的任务设计、同步与资源管理的实用流程与检查清单，帮助在 STM32H7 上稳定落地。

## Workflow

按以下顺序执行；若现有信息不足，先补充需求与约束。

### 1) 需求拆解
- 明确周期性/事件驱动/实时性任务，列出输入/输出与时限。
- 标注硬实时/软实时与允许的最大延迟。

### 2) 任务划分与优先级
- 先定关键路径，再定支持性任务。
- 使用优先级矩阵：实时性高/阻塞少优先。
- 避免过多同优先级导致不确定性。

### 3) 栈与内存规划
- 估算栈峰值，预留裕量；必要时用高水位检查。
- 统一任务栈/队列/缓冲区的归属与生命周期。

### 4) 同步与通信（CMSIS-RTOS2 优先）
- 数据流优先使用 `osMessageQueue`，事件同步用 `osEventFlags`。
- ISR 到任务：使用 `osMessageQueuePut`/`osThreadFlagsSet` 的 ISR 变体或对应安全用法。
- 互斥与临界区使用 `osMutex`/`osKernelLock`，避免优先级反转。

### 5) 调度与时基
- 评估 tick 频率对功耗与时延的影响。
- 若需要低功耗，考虑 tickless 与唤醒源设计。

### 6) 测试与验证
- 压测消息拥塞、任务饿死、死锁、栈溢出。
- 记录最差调度延迟与关键路径执行时间。

## Review Checklist

- 任务优先级是否与实时性需求一致
- ISR 与任务的交互是否使用 CMSIS-RTOS2 的安全接口
- 共享资源是否有明确的互斥/原子策略
- 栈使用是否有测量与裕量
- 队列/缓冲区大小是否有依据（峰值估算）

## References

- 将任务设计模板、优先级矩阵示例、调试流程放入 `references/`。
- 若需要自动生成任务骨架或统计栈水位，可在 `scripts/` 增加脚本并在此处列出。
